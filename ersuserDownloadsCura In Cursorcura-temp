warning: in the working copy of 'client/src/components/consultation/full-consultation-interface.tsx', LF will be replaced by CRLF the next time Git touches it
[1mdiff --git a/client/src/components/consultation/full-consultation-interface.tsx b/client/src/components/consultation/full-consultation-interface.tsx[m
[1mindex 19bcece..894c174 100644[m
[1m--- a/client/src/components/consultation/full-consultation-interface.tsx[m
[1m+++ b/client/src/components/consultation/full-consultation-interface.tsx[m
[36m@@ -1369,6 +1369,7 @@[m [m${[m
   const [currentImageIndex, setCurrentImageIndex] = useState(0);[m
   const [anatomicalStep, setAnatomicalStep] = useState(1); // 1: Analysis, 2: Configuration, 3: Assessment[m
   const [isGeneratingPlan, setIsGeneratingPlan] = useState(false);[m
[32m+[m[32m  const [isDownloadingAnalysis, setIsDownloadingAnalysis] = useState(false);[m
 [m
   // PIXEL-ACCURATE OVERLAY SYSTEM - Refs and state for proper muscle highlighting[m
   const imageRef = useRef<HTMLImageElement>(null);[m
[36m@@ -4313,146 +4314,149 @@[m [m${[m
                 {/* View Anatomical Analysis Button - Only show after treatment plan is generated */}[m
                 {generatedTreatmentPlan && ([m
                   <div className="flex justify-center pt-4">[m
[32m+[m
                     <Button[m
                       onClick={async () => {[m
[31m-                      try {[m
[31m-                        console.log('[ANATOMICAL PDF STEP1] Button clicked');[m
[31m-                        const currentPatientId = patientId || patient?.id;[m
[31m-                        console.log('[ANATOMICAL PDF STEP1] Patient ID:', currentPatientId);[m
[31m-                        [m
[31m-                        if (!currentPatientId) {[m
[31m-                          toast({[m
[31m-                            title: "Error",[m
[31m-                            description: "Patient information not available.",[m
[31m-                            variant: "destructive"[m
[31m-                          });[m
[31m-                          return;[m
[31m-                        }[m
[31m-[m
[31m-                        // If image not saved, save it automatically[m
[31m-                        let imagePathToUse = savedAnatomicalImage;[m
[31m-                        if (!imagePathToUse) {[m
[31m-                          if (!selectedMuscleGroup || !imageRef.current || !canvasRef.current) {[m
[32m+[m[32m                        setIsDownloadingAnalysis(true);[m
[32m+[m[32m                        try {[m
[32m+[m[32m                          console.log('[ANATOMICAL PDF STEP1] Button clicked');[m
[32m+[m[32m                          const currentPatientId = patientId || patient?.id;[m
[32m+[m[32m                          console.log('[ANATOMICAL PDF STEP1] Patient ID:', currentPatientId);[m
[32m+[m[41m                          [m
[32m+[m[32m                          if (!currentPatientId) {[m
                             toast({[m
[31m-                              title: "Cannot Generate PDF",[m
[31m-                              description: "Please select a muscle group first.",[m
[32m+[m[32m                              title: "Error",[m
[32m+[m[32m                              description: "Patient information not available.",[m
                               variant: "destructive"[m
                             });[m
                             return;[m
                           }[m
 [m
[31m-                          try {[m
[31m-                            const image = imageRef.current;[m
[31m-                            const canvas = canvasRef.current;[m
[31m-                            const ctx = canvas.getContext('2d');[m
[31m-                            [m
[31m-                            if (!ctx) return;[m
[31m-[m
[31m-                            canvas.width = image.naturalWidth;[m
[31m-                            canvas.height = image.naturalHeight;[m
[31m-                            ctx.drawImage(image, 0, 0, canvas.width, canvas.height);[m
[31m-[m
[31m-                            const staticPositions = getStaticMusclePositions();[m
[31m-                            const musclePositions = staticPositions.filter((pos: any) => {[m
[31m-                              const muscleValue = pos.value.toLowerCase().replace(/\s+/g, '_');[m
[31m-                              return muscleValue === selectedMuscleGroup.toLowerCase();[m
[31m-                            });[m
[31m-[m
[31m-                            musclePositions.forEach((position: any) => {[m
[31m-                              const x = position.coordinates.xPct * canvas.width;[m
[31m-                              const y = position.coordinates.yPct * canvas.height;[m
[31m-                              const radius = 20;[m
[31m-[m
[31m-                              ctx.beginPath();[m
[31m-                              ctx.arc(x, y, radius, 0, 2 * Math.PI);[m
[31m-                              ctx.fillStyle = 'rgba(255, 255, 0, 0.7)';[m
[31m-                              ctx.fill();[m
[31m-                              ctx.strokeStyle = 'rgba(255, 215, 0, 1)';[m
[31m-                              ctx.lineWidth = 3;[m
[31m-                              ctx.stroke();[m
[31m-[m
[31m-                              ctx.beginPath();[m
[31m-                              ctx.arc(x, y, 10, 0, 2 * Math.PI);[m
[31m-                              ctx.fillStyle = 'rgba(255, 255, 0, 0.9)';[m
[31m-                              ctx.fill();[m
[31m-                              ctx.strokeStyle = 'rgba(255, 215, 0, 1)';[m
[31m-                              ctx.lineWidth = 2;[m
[31m-                              ctx.stroke();[m
[31m-                            });[m
[32m+[m[32m                          // If image not saved, save it automatically[m
[32m+[m[32m                          let imagePathToUse = savedAnatomicalImage;[m
[32m+[m[32m                          if (!imagePathToUse) {[m
[32m+[m[32m                            if (!selectedMuscleGroup || !imageRef.current || !canvasRef.current) {[m
[32m+[m[32m                              toast({[m
[32m+[m[32m                                title: "Cannot Generate PDF",[m
[32m+[m[32m                                description: "Please select a muscle group first.",[m
[32m+[m[32m                                variant: "destructive"[m
[32m+[m[32m                              });[m
[32m+[m[32m                              return;[m
[32m+[m[32m                            }[m
 [m
[31m-                            const imageData = canvas.toDataURL('image/png');[m
[31m-                            [m
[31m-                            const token = localStorage.getItem('auth_token');[m
[31m-                            const saveResponse = await fetch('/api/anatomical-analysis/save-image', {[m
[31m-                              method: 'POST',[m
[31m-                              headers: {[m
[31m-                                'Authorization': `Bearer ${token}`,[m
[31m-                                'X-Tenant-Subdomain': getTenantSubdomain(),[m
[31m-                                'Content-Type': 'application/json',[m
[31m-                              },[m
[31m-                              body: JSON.stringify({[m
[31m-                                patientId: currentPatientId,[m
[31m-                                imageData: imageData,[m
[31m-                                muscleGroup: selectedMuscleGroup[m
[31m-                              })[m
[31m-                            });[m
[32m+[m[32m                            try {[m
[32m+[m[32m                              const image = imageRef.current;[m
[32m+[m[32m                              const canvas = canvasRef.current;[m
[32m+[m[32m                              const ctx = canvas.getContext('2d');[m
[32m+[m[41m                              [m
[32m+[m[32m                              if (!ctx) return;[m
[32m